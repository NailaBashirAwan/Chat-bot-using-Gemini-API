<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> AI Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* Custom scrollbar for message area */
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body class="p-4">

    <div id="app" class="w-full max-w-2xl bg-white shadow-xl rounded-2xl flex flex-col h-[85vh] md:h-[700px] overflow-hidden">

        <!-- Header -->
        <header class="p-5 bg-indigo-600 text-white rounded-t-2xl shadow-lg flex items-center justify-between">
            <h1 class="text-2xl font-bold">Chatbot</h1>
            <div class="text-sm opacity-80">Server-side powered by Django</div>
        </header>

        <!-- Message Area -->
        <main id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto">
            <!-- Initial Message -->
            <div class="flex justify-start">
                <div class="bg-gray-100 p-3 rounded-xl rounded-tl-sm max-w-xs md:max-w-md shadow-md">
                    <p class="text-sm text-gray-800">Hello! I'm an AI assistant. Type a message to chat.</p>
                </div>
            </div>
            <!-- Messages will be injected here -->
        </main>

        <!-- Input Area -->
        <footer class="p-4 border-t border-gray-200 bg-gray-50 flex items-center">
            <input type="hidden" id="csrf-token" value="dummy-csrf-token">

            <input
                type="text"
                id="user-input"
                placeholder="Type your message..."
                class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                onkeypress="if(event.key === 'Enter') sendMessage()"
            />
            <button
                id="send-button"
                onclick="sendMessage()"
                class="ml-3 p-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
            >
                <svg id="send-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                <div id="loading-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div>
            </button>
        </footer>
    </div>

    <script>
        // Changed to local URL for Django endpoint
        const chatApiUrl = '/api/gemini_chat/'; 
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const sendIcon = document.getElementById('send-icon');
        const MAX_RETRIES = 5;

        // Utility functions (displayMessage, formatText, setProcessingState) remain the same...

        function displayMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.className = 'flex ' + (sender === 'user' ? 'justify-end' : 'justify-start');

            const textContainer = document.createElement('div');
            textContainer.className = 'p-3 rounded-xl shadow-md max-w-xs md:max-w-md transition-all duration-300 ' +
                                    (sender === 'user'
                                        ? 'bg-indigo-500 text-white rounded-br-sm'
                                        : 'bg-gray-100 text-gray-800 rounded-tl-sm');

            textContainer.innerHTML = formatText(text);
            messageElement.appendChild(textContainer);
            chatMessages.appendChild(messageElement);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatText(text) {
            let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedText = formattedText.replace(/\n/g, '<br>');
            return formattedText;
        }

        function setProcessingState(isProcessing) {
            userInput.disabled = isProcessing;
            sendButton.disabled = isProcessing;
            if (isProcessing) {
                sendIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                sendIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        // Main function to send the message
        async function sendMessage() {
            const messageText = userInput.value.trim();
            if (!messageText) return;

            displayMessage(messageText, 'user');
            userInput.value = '';
            setProcessingState(true);

            let responseText = "Sorry, I couldn't get a response from the server. Please check the network or server logs.";

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    // Send message to the Django backend
                    const response = await fetch(chatApiUrl, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: messageText }) 
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < MAX_RETRIES - 1) {
                            const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000); 
                            await new Promise(resolve => setTimeout(resolve, delay));
                            console.warn(`Retry attempt ${i + 1} after ${Math.round(delay)}ms.`);
                            continue; 
                        } else {
                            throw new Error(`Server response error: ${response.statusText}`);
                        }
                    }

                    const result = await response.json();

                    if (result.response) {
                        responseText = result.response;
                    } else if (result.error) {
                        responseText = `Error from server: ${result.error}`;
                    } else {
                        responseText = "The server returned an empty or invalid response.";
                    }

                    break; // Success

                } catch (error) {
                    console.error("Chat API call failed:", error);
                    if (i === MAX_RETRIES - 1) {
                        responseText = "An unrecoverable error occurred. Check console for details.";
                    }
                    if (i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 500);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            displayMessage(responseText, 'gemini');
            setProcessingState(false);
            userInput.focus(); 
        }

        window.onload = () => {
            userInput.focus();
        };

    </script>
</body>
</html>